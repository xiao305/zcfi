<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>åšå®¢ç®¡ç† | zcfi.cn</title>
<!-- Favicon -->
<link rel="icon" type="image/svg+xml" href="../favicon/favicon.svg">
<link rel="icon" type="image/png" sizes="96x96" href="../favicon/favicon-96x96.png">
<link rel="icon" type="image/x-icon" href="../favicon/favicon.ico">
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- åå°å…¬å…±CSS -->
<link rel="stylesheet" href="assets/css/admin-common.css">
<style>
/* åšå®¢ç®¡ç†ç‰¹å®šæ ·å¼ */
.article-meta {
display: flex;
gap: 15px;
font-size: 13px;
color: #6c757d;
flex-wrap: wrap;
align-items: center;
}
.article-status {
display: inline-block;
padding: 4px 10px;
border-radius: 12px;
font-size: 12px;
font-weight: 500;
}
.status-published {
background-color: #d4edda;
color: #155724;
}
.status-draft {
background-color: #fff3cd;
color: #856404;
}
.status-page-generated {
background-color: #d1ecf1;
color: #0c5460;
border: 1px solid #bee5eb;
margin-left: 8px;
}
/* æƒé™æç¤ºæ  */
.permissions-banner {
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
color: white;
padding: 12px 20px;
border-radius: 8px;
margin-bottom: 20px;
display: flex;
justify-content: space-between;
align-items: center;
box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
}
.permissions-banner i {
margin-right: 10px;
font-size: 18px;
}
.permissions-info {
display: flex;
align-items: center;
gap: 8px;
cursor: help;
}
.permissions-info:hover .tooltip-text {
display: block;
}
.tooltip-text {
display: none;
position: absolute;
background: rgba(0,0,0,0.9);
color: white;
padding: 8px 12px;
border-radius: 6px;
font-size: 13px;
margin-top: 5px;
white-space: nowrap;
z-index: 1000;
}
/* æ–‡ç« ç¼–è¾‘å¼¹çª—ç‰¹å®šæ ·å¼ */
.form-modal .modal-content {
max-width: 700px;
text-align: left;
}
.form-modal .modal-header {
text-align: center;
}
/* é«˜çº§é…ç½®å¼¹çª—æ ·å¼ */
.advanced-config-modal .modal-content {
max-width: 600px;
}
.config-option {
margin-bottom: 15px;
padding: 15px;
background: #f8f9fa;
border-radius: 8px;
border: 1px solid #e9ecef;
}
.config-option h4 {
margin: 0 0 10px 0;
color: #495057;
font-size: 15px;
display: flex;
align-items: center;
gap: 8px;
}
.config-option p {
margin: 5px 0 0 0;
font-size: 13px;
color: #6c757d;
}
.page-url-preview {
background: white;
padding: 10px;
border-radius: 6px;
border: 1px dashed #4a6fa5;
font-family: 'Courier New', monospace;
font-size: 13px;
word-break: break-all;
margin-top: 8px;
color: #4a6fa5;
}
/* å¼€å…³æ§ä»¶ */
.toggle-switch {
display: flex;
align-items: center;
gap: 10px;
margin: 10px 0;
}
.toggle-label {
font-size: 14px;
color: #495057;
}
.toggle-container {
position: relative;
width: 48px;
height: 24px;
}
.toggle-checkbox {
display: none;
}
.toggle-slider {
position: absolute;
cursor: pointer;
top: 0;
left: 0;
right: 0;
bottom: 0;
background-color: #ccc;
transition: .4s;
border-radius: 34px;
}
.toggle-slider:before {
position: absolute;
content: "";
height: 18px;
width: 18px;
left: 3px;
bottom: 3px;
background-color: white;
transition: .4s;
border-radius: 50%;
}
.toggle-checkbox:checked + .toggle-slider {
background-color: #4a6fa5;
}
.toggle-checkbox:checked + .toggle-slider:before {
transform: translateX(24px);
}
/* æŒ‰é’®ç»„æ ·å¼ */
.action-buttons {
display: flex;
gap: 8px;
flex-wrap: wrap;
}
.advanced-btn {
background: #6c757d;
color: white;
border: none;
padding: 8px 15px;
border-radius: 6px;
cursor: pointer;
font-size: 13px;
display: flex;
align-items: center;
gap: 5px;
transition: all 0.3s ease;
}
.advanced-btn:hover {
background: #5a6268;
transform: translateY(-1px);
box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.advanced-btn:disabled {
background: #adb5bd;
cursor: not-allowed;
opacity: 0.6;
}
/* çŠ¶æ€é¢„è§ˆ */
.page-status-preview {
padding: 6px 12px;
border-radius: 20px;
font-size: 12px;
font-weight: 500;
}
.status-preview-published {
background: #d4edda;
color: #155724;
}
.status-preview-draft {
background: #fff3cd;
color: #856404;
}
.status-preview-archived {
background: #e2e3e5;
color: #383d41;
}
.status-preview-disabled {
background: #dc3545;
color: white;
}
/* ç§»åŠ¨ç«¯ä¼˜åŒ– */
@media (max-width: 768px) {
.admin-card-header {
flex-direction: column;
gap: 10px;
}
.permissions-banner {
flex-direction: column;
gap: 10px;
text-align: center;
}
.action-buttons {
flex-direction: column;
}
.advanced-btn {
width: 100%;
}
}
</style>
</head>
<body class="admin-body">
<div class="admin-container">
<div class="admin-header">
<a href="index.html" class="nav-back">
<i class="fas fa-arrow-left"></i> è¿”å›
</a>
<a href="https://zcfi.cn" class="admin-logo">zcfi<span>.</span>cn</a>
<div class="header-title">
<h1><i class="fas fa-blog"></i> åšå®¢å†…å®¹ç®¡ç†</h1>
<p>ç®¡ç†å’Œç»´æŠ¤æ‚¨çš„åšå®¢æ–‡ç« </p>
</div>
</div>
<div class="admin-main-content">
<!-- æƒé™æç¤ºæ  -->
<div class="permissions-banner" id="permissionsBanner">
<div>
<i class="fas fa-shield-alt"></i>
<span>Tokenæƒé™: <strong id="tokenPermissionLevel">æ£€æŸ¥ä¸­...</strong></span>
<div class="permissions-info">
<i class="fas fa-info-circle" style="font-size: 14px; margin-left: 8px;"></i>
<span class="tooltip-text">ç‚¹å‡»äº†è§£æƒé™è¯¦æƒ…</span>
</div>
</div>
<div id="permissionActions">
<!-- æƒé™ç›¸å…³æ“ä½œæŒ‰é’®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
</div>
</div>
<div class="admin-button-group">
<button class="admin-btn btn-primary" id="addArticleBtn">
<i class="fas fa-plus"></i> æ·»åŠ æ–°æ–‡ç« 
</button>
<button class="admin-btn btn-secondary" id="refreshBtn">
<i class="fas fa-sync-alt"></i> åˆ·æ–°æ–‡ç« åˆ—è¡¨
</button>
<button class="admin-btn btn-info" id="manageTemplateBtn" style="display: none;">
<i class="fas fa-file-code"></i> ç®¡ç†æ¨¡æ¿
</button>
</div>
<div class="admin-section">
<div class="section-header">
<h2><i class="fas fa-list"></i> æ–‡ç« åˆ—è¡¨</h2>
<span id="articlesCount">åŠ è½½ä¸­...</span>
</div>
<div id="articlesList">
<div class="admin-card">
<p>æ­£åœ¨åŠ è½½æ–‡ç« åˆ—è¡¨...</p>
</div>
</div>
</div>
<div class="admin-footer">
<p>Â© 2026 zcfi.cn åšå®¢ç®¡ç†ç³»ç»Ÿ</p>
<p style="margin-top: 10px; font-size: 13px; color: #6c757d;">
æç¤ºï¼šå¯ç”¨"ç”Ÿæˆç‹¬ç«‹é¡µé¢"åŠŸèƒ½éœ€è¦Tokenå…·æœ‰repoæƒé™ã€‚é¡µé¢å°†ç”Ÿæˆåœ¨GitHubä»“åº“çš„blogs/ç›®å½•ä¸‹ã€‚
</p>
</div>
</div>
</div>
<!-- æ·»åŠ /ç¼–è¾‘æ–‡ç« å¼¹çª— -->
<div class="custom-modal" id="articleModal">
<div class="modal-content form-modal">
<div class="modal-header">
<div class="modal-title" id="modalTitle">æ·»åŠ æ–°æ–‡ç« </div>
</div>
<div class="modal-body">
<input type="hidden" id="editPostId">
<div class="form-group">
<label for="postId"><i class="fas fa-hashtag"></i> æ–‡ç«  ID:</label>
<input type="text" id="postId" placeholder="ä¾‹å¦‚: post3" readonly>
</div>
<div class="form-group">
<label for="title"><i class="fas fa-heading"></i> æ–‡ç« æ ‡é¢˜:</label>
<input type="text" id="title" placeholder="è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜">
</div>
<div class="form-group">
<label for="date"><i class="fas fa-calendar"></i> å‘å¸ƒæ—¥æœŸ:</label>
<input type="text" id="date" placeholder="ä¾‹å¦‚: 2026å¹´1æœˆ25æ—¥">
</div>
<div class="form-group">
<label for="customUrl"><i class="fas fa-link"></i> è‡ªå®šä¹‰ç½‘å€ (å¯é€‰):</label>
<input type="text" id="customUrl" placeholder="ä¾‹å¦‚: /blog/my-article.html (ç•™ç©ºä½¿ç”¨é»˜è®¤)">
</div>
<div class="form-group">
<label for="status"><i class="fas fa-toggle-on"></i> æ–‡ç« çŠ¶æ€:</label>
<select id="status">
<option value="published">å·²å‘å¸ƒ (å±•ç¤ºä¸­)</option>
<option value="draft">è‰ç¨¿ (éšè—)</option>
<option value="archived">å·²å½’æ¡£</option>
</select>
</div>
<div class="form-group">
<label for="excerpt"><i class="fas fa-align-left"></i> æ–‡ç« æ‘˜è¦:</label>
<textarea id="excerpt" placeholder="è¯·è¾“å…¥æ–‡ç« æ‘˜è¦ï¼ˆç®€çŸ­æè¿°ï¼‰"></textarea>
</div>
<div class="form-group">
<label for="content"><i class="fas fa-file-alt"></i> å®Œæ•´å†…å®¹ (æ”¯æŒ HTML):</label>
<textarea id="content" placeholder="è¯·è¾“å…¥å®Œæ•´çš„æ–‡ç« å†…å®¹ï¼Œå¯ä»¥åŒ…å« HTML æ ‡ç­¾"></textarea>
</div>
</div>
<div class="modal-buttons">
<button class="modal-btn btn-secondary" id="cancelArticleBtn">å–æ¶ˆ</button>
<button class="modal-btn btn-primary" id="saveArticleBtn">ä¿å­˜æ–‡ç« </button>
</div>
</div>
</div>
<!-- é«˜çº§é…ç½®å¼¹çª— -->
<div class="custom-modal" id="advancedConfigModal">
<div class="modal-content advanced-config-modal">
<div class="modal-header">
<i class="fas fa-cog"></i>
</div>
<div class="modal-title">é«˜çº§é…ç½® - <span id="advancedConfigPostId"></span></div>
<div class="modal-message">
<!-- é¡µé¢çŠ¶æ€é¢„è§ˆ -->
<div class="config-option">
<h4><i class="fas fa-eye"></i> é¡µé¢çŠ¶æ€</h4>
<p>å½“å‰é¡µé¢çŠ¶æ€é¢„è§ˆ:</p>
<div id="pageStatusPreview" style="margin: 10px 0; padding: 8px 15px; border-radius: 6px; background: #f1f3f4; font-size: 14px;">
<span id="statusText">æ£€æŸ¥ä¸­...</span>
</div>
</div>
<!-- é¡µé¢å¯ç”¨å¼€å…³ -->
<div class="config-option">
<h4><i class="fas fa-toggle-on"></i> é¡µé¢å¯ç”¨</h4>
<p>æ§åˆ¶é¡µé¢æ˜¯å¦å¯è®¿é—®</p>
<div class="toggle-switch">
<label class="toggle-container">
<input type="checkbox" id="pageEnabledToggle" class="toggle-checkbox" checked>
<span class="toggle-slider"></span>
</label>
<span class="toggle-label" id="pageEnabledLabel">é¡µé¢å¯ç”¨</span>
</div>
</div>
<!-- é¡µé¢ç”Ÿæˆé…ç½® -->
<div class="config-option">
<h4><i class="fas fa-file-code"></i> ç”Ÿæˆç‹¬ç«‹é¡µé¢</h4>
<p>ä¸ºæ–‡ç« ç”Ÿæˆç‹¬ç«‹çš„HTMLé¡µé¢ï¼Œå¯é€šè¿‡é“¾æ¥ç›´æ¥è®¿é—®</p>
<div class="toggle-switch">
<label class="toggle-container">
<input type="checkbox" id="generatePageToggle" class="toggle-checkbox">
<span class="toggle-slider"></span>
</label>
<span class="toggle-label" id="generatePageLabel">ä¸ç”Ÿæˆ (ä»…åœ¨åšå®¢åˆ—è¡¨æ˜¾ç¤º)</span>
</div>
<div id="pageUrlSection" style="display: none; margin-top: 10px;">
<p style="font-size: 13px; color: #495057; margin-bottom: 5px;">
é¡µé¢URL: <span class="page-url-preview" id="pageUrlPreview"></span>
</p>
<p style="font-size: 12px; color: #6c757d;">
æ³¨æ„ï¼šå¯ç”¨é¡µé¢ç”ŸæˆåŠŸèƒ½åï¼Œè‡ªå®šä¹‰URLå°†è¢«å¿½ç•¥ï¼Œä½¿ç”¨é»˜è®¤è·¯å¾„
</p>
</div>
</div>
<!-- ä½œè€…ä¿¡æ¯ -->
<div class="config-option">
<h4><i class="fas fa-user"></i> ä½œè€…ä¿¡æ¯</h4>
<p>è®¾ç½®æ–‡ç« ä½œè€…ï¼ˆå¯é€‰ï¼‰</p>
<div class="form-group" style="margin-bottom: 0;">
<label for="pageAuthor" style="font-size: 13px; margin-bottom: 4px;">ä½œè€…:</label>
<input type="text" id="pageAuthor" placeholder="ä¾‹å¦‚: å¼ ä¸‰" style="padding: 8px 12px; font-size: 13px;">
</div>
</div>
<!-- æ ‡ç­¾ç®¡ç† -->
<div class="config-option">
<h4><i class="fas fa-tags"></i> æ–‡ç« æ ‡ç­¾</h4>
<p>ç”¨é€—å·åˆ†éš”å¤šä¸ªæ ‡ç­¾</p>
<div class="form-group" style="margin-bottom: 0;">
<label for="pageTags" style="font-size: 13px; margin-bottom: 4px;">æ ‡ç­¾:</label>
<input type="text" id="pageTags" placeholder="ä¾‹å¦‚: æŠ€æœ¯,å‰ç«¯,JavaScript" style="padding: 8px 12px; font-size: 13px;">
</div>
</div>
<!-- SEOé…ç½® -->
<div class="config-option">
<h4><i class="fas fa-search"></i> SEOä¼˜åŒ–</h4>
<p>ä¸ºç‹¬ç«‹é¡µé¢è®¾ç½®SEOç›¸å…³ä¿¡æ¯</p>
<div class="form-group" style="margin-bottom: 8px;">
<label for="seoKeywords" style="font-size: 13px; margin-bottom: 4px;">é¡µé¢å…³é”®è¯:</label>
<input type="text" id="seoKeywords" placeholder="ä¾‹å¦‚: æŠ€æœ¯åšå®¢,å‰ç«¯å¼€å‘,ä¸ªäººç½‘ç«™" style="padding: 8px 12px; font-size: 13px;">
</div>
<div class="form-group" style="margin-bottom: 0;">
<label for="seoDescription" style="font-size: 13px; margin-bottom: 4px;">é¡µé¢æè¿°:</label>
<textarea id="seoDescription" rows="2" placeholder="é¡µé¢çš„ç®€çŸ­æè¿°ï¼Œç”¨äºæœç´¢å¼•æ“å±•ç¤º" style="padding: 8px 12px; font-size: 13px; resize: vertical;"></textarea>
</div>
</div>
</div>
<div class="modal-buttons">
<button class="modal-btn btn-secondary" id="cancelAdvancedConfigBtn">å–æ¶ˆ</button>
<button class="modal-btn btn-primary" id="saveAdvancedConfigBtn">ä¿å­˜é…ç½®</button>
</div>
</div>
</div>
<!-- ç¡®è®¤å¼¹çª— -->
<div class="custom-modal" id="confirmModal">
<div class="modal-content">
<div class="modal-header">
<i class="fas fa-question-circle"></i>
</div>
<div class="modal-title" id="confirmTitle">ç¡®è®¤æ“ä½œ</div>
<div class="modal-message" id="confirmMessage">æ‚¨ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ</div>
<div class="modal-buttons">
<button class="modal-btn btn-secondary" id="cancelConfirmBtn">å–æ¶ˆ</button>
<button class="modal-btn btn-primary" id="confirmActionBtn">ç¡®è®¤</button>
</div>
</div>
</div>
<!-- æƒé™è¯¦æƒ…å¼¹çª— -->
<div class="custom-modal" id="permissionDetailsModal">
<div class="modal-content">
<div class="modal-header">
<i class="fas fa-shield-alt"></i>
</div>
<div class="modal-title">Tokenæƒé™è¯¦æƒ…</div>
<div class="modal-message">
<div style="text-align: left; line-height: 1.8;">
<h4 style="color: #495057; margin-bottom: 15px;"><i class="fas fa-key"></i> å½“å‰Tokenæƒé™:</h4>
<ul style="margin-left: 20px; margin-bottom: 20px;">
<li id="permissionGist">Gistæƒé™: <span id="permissionGistStatus">æ£€æŸ¥ä¸­...</span></li>
<li id="permissionRepo">Repoæƒé™: <span id="permissionRepoStatus">æ£€æŸ¥ä¸­...</span></li>
</ul>
<h4 style="color: #495057; margin-bottom: 15px;"><i class="fas fa-tasks"></i> åŠŸèƒ½å¯¹åº”æƒé™:</h4>
<ul style="margin-left: 20px;">
<li><strong>Gistæƒé™</strong>: åŸºç¡€åŠŸèƒ½ï¼Œç®¡ç†åšå®¢æ–‡ç« ã€ä½œå“é›†ã€ç•™è¨€ç­‰</li>
<li><strong>Repoæƒé™</strong>: é«˜çº§åŠŸèƒ½ï¼Œè‡ªåŠ¨ç”Ÿæˆåšå®¢ç‹¬ç«‹é¡µé¢</li>
</ul>
<p style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 14px;">
<strong>æç¤º:</strong> å¦‚éœ€ä½¿ç”¨"è‡ªåŠ¨ç”Ÿæˆåšå®¢é¡µé¢"åŠŸèƒ½ï¼Œè¯·åœ¨
<a href="https://github.com/settings/tokens" target="_blank" style="color: #4a6fa5; text-decoration: none;">GitHub Tokenè®¾ç½®</a>
ä¸­é‡æ–°ç”ŸæˆTokenï¼Œå‹¾é€‰ <code>repo</code> æƒé™ã€‚
</p>
</div>
</div>
<div class="modal-buttons">
<button class="modal-btn btn-primary" id="closePermissionDetailsBtn">ç¡®å®š</button>
</div>
</div>
</div>
<!-- æ¨¡æ¿ç®¡ç†å¼¹çª— -->
<div class="custom-modal" id="templateModal">
<div class="modal-content form-modal">
<div class="modal-header">
<div class="modal-title" id="templateModalTitle">ç®¡ç†é¡µé¢æ¨¡æ¿</div>
</div>
<div class="modal-body">
<div class="form-group">
<label><i class="fas fa-code"></i> æ¨¡æ¿å†…å®¹ (HTML):</label>
<textarea id="templateContent" style="height: 400px; font-family: monospace; font-size: 13px; width: 100%;" placeholder="è¯·è¾“å…¥HTMLæ¨¡æ¿å†…å®¹..."></textarea>
</div>
<div class="form-group">
<h4><i class="fas fa-info-circle"></i> å¯ç”¨å˜é‡:</h4>
<div style="background: #f8f9fa; padding: 15px; border-radius: 6px; font-size: 13px;">
<code>{{title}}</code> - æ–‡ç« æ ‡é¢˜<br>
<code>{{siteName}}</code> - ç½‘ç«™åç§°<br>
<code>{{seoKeywords}}</code> - SEOå…³é”®è¯<br>
<code>{{seoDescription}}</code> - SEOæè¿°<br>
<code>{{pageUrl}}</code> - é¡µé¢URL<br>
<code>{{publishDate}}</code> - å‘å¸ƒæ—¥æœŸ<br>
<code>{{lastUpdated}}</code> - æœ€åæ›´æ–°<br>
<code>{{author}}</code> - ä½œè€…<br>
<code>{{postId}}</code> - æ–‡ç« ID<br>
<code>{{status}}</code> - çŠ¶æ€ (published/draft/archived)<br>
<code>{{enabled}}</code> - æ˜¯å¦å¯ç”¨ (true/false)<br>
<code>{{content}}</code> - æ–‡ç« å†…å®¹<br>
<code>{{tags}}</code> - æ ‡ç­¾æ•°ç»„<br>
<br>
<strong>æ¡ä»¶è¯­å¥:</strong><br>
<code>{{#if variable}}å†…å®¹{{/if}}</code><br>
<code>{{#unless variable}}å†…å®¹{{/unless}}</code><br>
<code>{{#if (eq variable "value")}}å†…å®¹{{/if}}</code><br>
<br>
<strong>å¾ªç¯è¯­å¥:</strong><br>
<code>{{#each tags}}&lt;span&gt;{{this}}&lt;/span&gt;{{/each}}</code>
</div>
</div>
</div>
<div class="modal-buttons">
<button class="modal-btn btn-secondary" id="cancelTemplateBtn">å–æ¶ˆ</button>
<button class="modal-btn btn-primary" id="saveTemplateBtn">ä¿å­˜æ¨¡æ¿</button>
</div>
</div>
</div>
<!-- åŠ è½½å¼¹çª— -->
<div class="custom-modal" id="loadingModal">
<div class="modal-content">
<div class="modal-header">
<i class="fas fa-spinner loading-spinner"></i>
</div>
<div class="modal-title" id="loadingTitle">å¤„ç†ä¸­</div>
<div class="modal-message" id="loadingMessage">æ­£åœ¨å¤„ç†æ‚¨çš„è¯·æ±‚ï¼Œè¯·ç¨å€™...</div>
</div>
</div>
<!-- ç»“æœå¼¹çª— -->
<div class="custom-modal" id="resultModal">
<div class="modal-content">
<div class="modal-header">
<i class="fas fa-info-circle" id="resultIcon"></i>
</div>
<div class="modal-title" id="resultTitle">æ“ä½œç»“æœ</div>
<div class="modal-message" id="resultMessage">æ“ä½œå·²å®Œæˆ</div>
<div class="modal-buttons">
<button class="modal-btn btn-primary" id="closeResultBtn">ç¡®å®š</button>
</div>
</div>
</div>
<script>
// å®‰å…¨éªŒè¯
if (!sessionStorage.getItem('admin_verified') || !sessionStorage.getItem('admin_token')) {
alert('âŒ æœªæˆæƒè®¿é—®ï¼è¯·é€šè¿‡åå°é¦–é¡µç™»å½•ã€‚');
window.location.href = 'index.html';
}
// å…¨å±€é…ç½®
const GIST_ID = '73cc78400c25eb9effed665e2c89843d';
const GIST_URL = `https://api.github.com/gists/${GIST_ID}`;
const REPO_OWNER = 'xiao305';
const REPO_NAME = 'zcfi';
const REPO_BRANCH = 'main';
const TEMPLATE_PATH = 'blogs/template.html';
const token = sessionStorage.getItem('admin_token');
const permissions = JSON.parse(sessionStorage.getItem('admin_permissions') || '{}');
// å…¨å±€çŠ¶æ€
let currentBlogData = [];
let pendingAction = null;
let pendingActionData = null;
let hasRepoPermission = false;
// CORSä»£ç†åˆ—è¡¨
const CORS_PROXIES = [
'https://api.allorigins.win/raw?url=',
'https://corsproxy.io/?',
'https://api.codetabs.com/v1/proxy?quest='
];
// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
initEventListeners();
checkAndDisplayPermissions();
loadBlogData(true);
});
// æ£€æŸ¥å¹¶æ˜¾ç¤ºæƒé™
function checkAndDisplayPermissions() {
const banner = document.getElementById('permissionsBanner');
const permissionLevel = document.getElementById('tokenPermissionLevel');
const permissionGistStatus = document.getElementById('permissionGistStatus');
const permissionRepoStatus = document.getElementById('permissionRepoStatus');
const permissionActions = document.getElementById('permissionActions');
const manageTemplateBtn = document.getElementById('manageTemplateBtn');
if (permissions.gist && permissions.repo) {
banner.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
permissionLevel.innerHTML = '<i class="fas fa-check-circle"></i> å®Œæ•´æƒé™ (Gist + Repo)';
permissionGistStatus.innerHTML = '<span style="color: #28a745;">âœ“ å·²æˆæƒ</span>';
permissionRepoStatus.innerHTML = '<span style="color: #28a745;">âœ“ å·²æˆæƒ</span>';
hasRepoPermission = true;
manageTemplateBtn.style.display = 'inline-flex';
} else if (permissions.gist && !permissions.repo) {
banner.style.background = 'linear-gradient(135deg, #ffc107 0%, #fd7e14 100%)';
permissionLevel.innerHTML = '<i class="fas fa-exclamation-triangle"></i> åŸºç¡€æƒé™ (ä»…Gist)';
permissionGistStatus.innerHTML = '<span style="color: #28a745;">âœ“ å·²æˆæƒ</span>';
permissionRepoStatus.innerHTML = '<span style="color: #dc3545;">âœ— æœªæˆæƒ</span>';
hasRepoPermission = false;
permissionActions.innerHTML = `
<button class="admin-btn btn-warning" onclick="showPermissionDetails()" style="padding: 6px 15px; font-size: 13px;">
<i class="fas fa-info-circle"></i> æŸ¥çœ‹æƒé™è¯¦æƒ…
</button>
`;
} else {
banner.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
permissionLevel.innerHTML = '<i class="fas fa-times-circle"></i> æƒé™ä¸è¶³';
permissionGistStatus.innerHTML = '<span style="color: #dc3545;">âœ— æœªæˆæƒ</span>';
permissionRepoStatus.innerHTML = '<span style="color: #dc3545;">âœ— æœªæˆæƒ</span>';
hasRepoPermission = false;
}
document.querySelector('.permissions-info').addEventListener('click', showPermissionDetails);
}
// æ˜¾ç¤ºæƒé™è¯¦æƒ…
function showPermissionDetails() {
showModal('permissionDetailsModal');
}
// åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
function initEventListeners() {
document.getElementById('addArticleBtn').addEventListener('click', openAddModal);
document.getElementById('refreshBtn').addEventListener('click', function() {
loadBlogData(false, true);
});
document.getElementById('manageTemplateBtn').addEventListener('click', manageTemplate);
document.getElementById('cancelArticleBtn').addEventListener('click', closeArticleModal);
document.getElementById('saveArticleBtn').addEventListener('click', saveArticle);
document.getElementById('cancelAdvancedConfigBtn').addEventListener('click', closeAdvancedConfigModal);
document.getElementById('saveAdvancedConfigBtn').addEventListener('click', saveAdvancedConfig);
document.getElementById('closePermissionDetailsBtn').addEventListener('click', closePermissionDetailsModal);
document.getElementById('cancelConfirmBtn').addEventListener('click', closeConfirmModal);
document.getElementById('confirmActionBtn').addEventListener('click', executeConfirmedAction);
document.getElementById('cancelTemplateBtn').addEventListener('click', closeTemplateModal);
document.getElementById('saveTemplateBtn').addEventListener('click', saveTemplate);
document.getElementById('closeResultBtn').addEventListener('click', closeResultModal);
document.getElementById('generatePageToggle').addEventListener('change', function() {
document.getElementById('generatePageLabel').textContent =
this.checked ? 'ç”Ÿæˆç‹¬ç«‹é¡µé¢' : 'ä¸ç”Ÿæˆ (ä»…åœ¨åšå®¢åˆ—è¡¨æ˜¾ç¤º)';
document.getElementById('pageUrlSection').style.display = this.checked ? 'block' : 'none';
updatePageUrlPreview();
});
document.getElementById('pageEnabledToggle').addEventListener('change', function() {
document.getElementById('pageEnabledLabel').textContent =
this.checked ? 'é¡µé¢å¯ç”¨' : 'é¡µé¢ç¦ç”¨';
updatePageStatusPreview();
});
document.addEventListener('keydown', function(e) {
if (e.key === 'Escape') {
closeAllModals();
}
});
document.querySelectorAll('.custom-modal').forEach(modal => {
modal.addEventListener('click', function(e) {
if (e.target === this) {
closeAllModals();
}
});
});
}
// æ›´æ–°é¡µé¢URLé¢„è§ˆ
function updatePageUrlPreview() {
const postId = document.getElementById('advancedConfigPostId').textContent;
const previewElement = document.getElementById('pageUrlPreview');
if (!postId) return;
const pageUrl = `https://zcfi.cn/blogs/${postId}.html`;
previewElement.textContent = pageUrl;
}
// æ›´æ–°é¡µé¢çŠ¶æ€é¢„è§ˆ
function updatePageStatusPreview() {
const postId = document.getElementById('advancedConfigPostId').textContent;
const post = currentBlogData.find(p => p.id === postId);
if (!post) return;
const enabled = document.getElementById('pageEnabledToggle').checked;
const status = post.status || 'published';
const statusElement = document.getElementById('statusText');
let statusText = '';
let statusClass = '';
if (!enabled) {
statusText = 'âŒ å·²ç¦ç”¨ï¼ˆé¡µé¢ä¸å¯è®¿é—®ï¼‰';
statusClass = 'status-preview-disabled';
} else if (status === 'published') {
statusText = 'âœ… å·²å‘å¸ƒï¼ˆé¡µé¢æ­£å¸¸è®¿é—®ï¼‰';
statusClass = 'status-preview-published';
} else if (status === 'draft') {
statusText = 'ğŸ“ è‰ç¨¿ï¼ˆä»…ç®¡ç†å‘˜å¯è§ï¼‰';
statusClass = 'status-preview-draft';
} else if (status === 'archived') {
statusText = 'ğŸ—„ï¸ å·²å½’æ¡£ï¼ˆé¡µé¢å·²å­˜æ¡£ï¼‰';
statusClass = 'status-preview-archived';
}
statusElement.innerHTML = `<span class="${statusClass}">${statusText}</span>`;
}
// å¼¹çª—æ§åˆ¶å‡½æ•°
function openAddModal() {
document.getElementById('modalTitle').textContent = 'æ·»åŠ æ–°æ–‡ç« ';
document.getElementById('editPostId').value = '';
document.getElementById('saveArticleBtn').textContent = 'ä¿å­˜æ–‡ç« ';
document.getElementById('postId').value = '';
document.getElementById('title').value = '';
document.getElementById('date').value = '';
document.getElementById('customUrl').value = '';
document.getElementById('excerpt').value = '';
document.getElementById('content').value = '';
document.getElementById('status').value = 'published';
suggestNextPostId(currentBlogData);
showModal('articleModal');
}
function openEditModal(postId) {
const post = currentBlogData.find(p => p.id === postId);
if (!post) {
showResult('error', 'é”™è¯¯', 'æœªæ‰¾åˆ°æŒ‡å®šæ–‡ç« ');
return;
}
document.getElementById('modalTitle').textContent = 'ç¼–è¾‘æ–‡ç« ';
document.getElementById('editPostId').value = post.id;
document.getElementById('saveArticleBtn').textContent = 'ä¿å­˜ä¿®æ”¹';
document.getElementById('postId').value = post.id;
document.getElementById('title').value = post.title;
document.getElementById('date').value = post.date;
document.getElementById('customUrl').value = post.customUrl || '';
document.getElementById('excerpt').value = post.excerpt;
document.getElementById('content').value = post.content;
document.getElementById('status').value = post.status || 'published';
showModal('articleModal');
}
function closeArticleModal() {
hideModal('articleModal');
}
// é«˜çº§é…ç½®å¼¹çª—
function openAdvancedConfigModal(postId) {
const post = currentBlogData.find(p => p.id === postId);
if (!post) {
showResult('error', 'é”™è¯¯', 'æœªæ‰¾åˆ°æŒ‡å®šæ–‡ç« ');
return;
}
if (!hasRepoPermission) {
showResult('info', 'æƒé™ä¸è¶³', 'å½“å‰Tokenç¼ºå°‘repoæƒé™ï¼Œæ— æ³•ä½¿ç”¨é¡µé¢ç”ŸæˆåŠŸèƒ½ã€‚è¯·åœ¨GitHub Tokenè®¾ç½®ä¸­æ·»åŠ repoæƒé™ã€‚');
return;
}
document.getElementById('advancedConfigPostId').textContent = postId;
const generatePageToggle = document.getElementById('generatePageToggle');
generatePageToggle.checked = post.generatePage || false;
document.getElementById('generatePageLabel').textContent =
(post.generatePage ? 'ç”Ÿæˆç‹¬ç«‹é¡µé¢' : 'ä¸ç”Ÿæˆ (ä»…åœ¨åšå®¢åˆ—è¡¨æ˜¾ç¤º)');
document.getElementById('pageUrlSection').style.display = post.generatePage ? 'block' : 'none';
document.getElementById('pageEnabledToggle').checked = post.enabled !== false;
document.getElementById('pageEnabledLabel').textContent =
(post.enabled !== false ? 'é¡µé¢å¯ç”¨' : 'é¡µé¢ç¦ç”¨');
document.getElementById('seoKeywords').value = post.seoKeywords || '';
document.getElementById('seoDescription').value = post.seoDescription || '';
document.getElementById('pageAuthor').value = post.author || '';
document.getElementById('pageTags').value = (post.tags || []).join(', ');
updatePageUrlPreview();
updatePageStatusPreview();
showModal('advancedConfigModal');
}
function closeAdvancedConfigModal() {
hideModal('advancedConfigModal');
}
function saveAdvancedConfig() {
const postId = document.getElementById('advancedConfigPostId').textContent;
const generatePage = document.getElementById('generatePageToggle').checked;
const seoKeywords = document.getElementById('seoKeywords').value.trim();
const seoDescription = document.getElementById('seoDescription').value.trim();
const author = document.getElementById('pageAuthor').value.trim();
const tags = document.getElementById('pageTags').value
.split(',')
.map(tag => tag.trim())
.filter(tag => tag.length > 0);
const enabled = document.getElementById('pageEnabledToggle').checked;
const postIndex = currentBlogData.findIndex(p => p.id === postId);
if (postIndex === -1) {
showResult('error', 'é”™è¯¯', 'æœªæ‰¾åˆ°æŒ‡å®šæ–‡ç« ');
closeAdvancedConfigModal();
return;
}
showLoading('ä¿å­˜é…ç½®', 'æ­£åœ¨ä¿å­˜é«˜çº§é…ç½®...');
setTimeout(async () => {
try {
const currentData = await fetchCurrentData();
const post = currentData.find(p => p.id === postId);
if (!post) {
throw new Error('æœªæ‰¾åˆ°æŒ‡å®šæ–‡ç« ');
}
post.generatePage = generatePage;
post.seoKeywords = seoKeywords;
post.seoDescription = seoDescription;
post.author = author;
post.tags = tags;
post.enabled = enabled;
post.lastUpdated = new Date().toISOString().split('T')[0];
if (generatePage) {
await createOrUpdatePageFile(post);
} else {
await deletePageFile(postId);
}
await updateGistData(currentData);
currentBlogData = currentData;
hideLoading();
showResult('success', 'ä¿å­˜æˆåŠŸ', 'é«˜çº§é…ç½®å·²ä¿å­˜');
closeAdvancedConfigModal();
displayArticlesList(currentBlogData);
} catch (error) {
hideLoading();
showResult('error', 'ä¿å­˜å¤±è´¥', error.message);
}
}, 100);
}
// åˆ›å»º/æ›´æ–°é¡µé¢æ–‡ä»¶
async function createOrUpdatePageFile(post) {
if (!hasRepoPermission) {
throw new Error('ç¼ºå°‘repoæƒé™ï¼Œæ— æ³•ç”Ÿæˆé¡µé¢æ–‡ä»¶');
}
try {
const pageContent = await buildPageContent(post);
const filePath = `blogs/${post.id}.html`;
let currentFile = null;
let fileExists = false;
try {
const checkUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${filePath}?ref=${REPO_BRANCH}`;
const checkResponse = await fetchWithRetry(checkUrl, {
headers: {
'Authorization': `token ${token}`,
'Accept': 'application/vnd.github.v3+json'
}
});
if (checkResponse.ok) {
currentFile = await checkResponse.json();
fileExists = true;
} else if (checkResponse.status === 404) {
fileExists = false;
}
} catch (error) {
fileExists = false;
}
const contentBase64 = btoa(unescape(encodeURIComponent(pageContent)));
const requestData = {
message: `Update blog page: ${post.title}`,
content: contentBase64,
branch: REPO_BRANCH
};
if (fileExists && currentFile && currentFile.sha) {
requestData.sha = currentFile.sha;
}
const apiUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${filePath}`;
const response = await fetchWithRetry(apiUrl, {
method: 'PUT',
headers: {
'Authorization': `token ${token}`,
'Accept': 'application/vnd.github.v3+json',
'Content-Type': 'application/json'
},
body: JSON.stringify(requestData)
});
if (!response.ok) {
const errorData = await response.json();
throw new Error(`åˆ›å»º/æ›´æ–°é¡µé¢æ–‡ä»¶å¤±è´¥: ${response.status} ${errorData.message || response.statusText}`);
}
return await response.json();
} catch (error) {
console.error('åˆ›å»º/æ›´æ–°é¡µé¢æ–‡ä»¶å¤±è´¥:', error);
throw error;
}
}
// æ„å»ºé¡µé¢å†…å®¹
async function buildPageContent(post) {
try {
// âœ… è·å–æ¨¡æ¿å†…å®¹ï¼ˆå·²ä¿®å¤ä¹±ç é—®é¢˜ï¼‰
let templateContent = await fetchTemplateFile();
// å‡†å¤‡æ¨¡æ¿æ•°æ®
const templateData = {
title: escapeHtml(post.title || 'åšå®¢æ–‡ç« '),
siteName: 'zcfi.cn',
seoKeywords: escapeHtml(post.seoKeywords || post.title || ''),
seoDescription: escapeHtml(post.seoDescription || post.excerpt || ''),
pageUrl: `https://zcfi.cn/blogs/${post.id}.html`,
publishDate: escapeHtml(post.date || ''),
lastUpdated: escapeHtml(post.lastUpdated || post.date || ''),
author: escapeHtml(post.author || ''),
content: post.content || '<p>æš‚æ— å†…å®¹</p>',
postId: post.id,
status: post.status || 'published',
enabled: (post.enabled !== false).toString(),
tags: post.tags || []
};
// æ¨¡æ¿å˜é‡æ›¿æ¢
let pageContent = templateContent;
// åŸºæœ¬å˜é‡æ›¿æ¢
Object.keys(templateData).forEach(key => {
const value = templateData[key];
const regex = new RegExp(`{{${key}}}`, 'g');
if (typeof value === 'string') {
pageContent = pageContent.replace(regex, value);
} else if (Array.isArray(value)) {
// æ•°ç»„å¤„ç†
const arrayRegex = new RegExp(`{{#each ${key}}}([\\s\\S]*?){{/each}}`, 'g');
pageContent = pageContent.replace(arrayRegex, (match, innerContent) => {
if (value.length === 0) return '';
return value.map(item => {
let result = innerContent;
result = result.replace(/\{\{this\}\}/g, escapeHtml(item));
return result;
}).join('');
});
}
});
// æ¡ä»¶è¯­å¥å¤„ç†
pageContent = processTemplateConditionals(pageContent, templateData);
return pageContent;
} catch (error) {
console.error('æ„å»ºé¡µé¢å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ¨¡æ¿:', error);
return buildFallbackPageContent(post);
}
}
// âœ… ä¿®å¤åçš„è·å–æ¨¡æ¿æ–‡ä»¶å‡½æ•°ï¼ˆä½¿ç”¨ Raw APIï¼Œé¿å…ä¹±ç ï¼‰
async function fetchTemplateFile() {
try {
// ä½¿ç”¨ Raw API è·å–æ¨¡æ¿æ–‡ä»¶ï¼ˆè‡ªåŠ¨ UTF-8 è§£ç ï¼‰
const rawUrl = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${REPO_BRANCH}/${TEMPLATE_PATH}`;
const response = await fetchWithRetry(rawUrl, {
headers: {
'Authorization': `token ${token}`,
'Accept': 'application/vnd.github.v3.raw'  // â­â­â­ å…³é”®ï¼šè·å–åŸå§‹å†…å®¹
}
});
if (response.ok) {
// âœ… ç›´æ¥è·å–æ–‡æœ¬ï¼Œè‡ªåŠ¨ UTF-8 è§£ç 
const content = await response.text();
return content;
} else {
throw new Error('æ¨¡æ¿æ–‡ä»¶è·å–å¤±è´¥');
}
} catch (error) {
console.warn('æ— æ³•è·å–æ¨¡æ¿æ–‡ä»¶ï¼Œä½¿ç”¨å†…ç½®æ¨¡æ¿:', error);
return `<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{{title}} | {{siteName}}</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
.article-title { color: #333; margin-bottom: 20px; }
.article-meta { color: #666; margin-bottom: 30px; }
.article-content { line-height: 1.6; }
</style>
</head>
<body>
<h1 class="article-title">{{title}}</h1>
<div class="article-meta">
<p>å‘å¸ƒæ—¶é—´: {{publishDate}} | æœ€åæ›´æ–°: {{lastUpdated}}</p>
</div>
<div class="article-content">
{{{content}}}
</div>
<p><a href="../blog.html">â† è¿”å›åšå®¢åˆ—è¡¨</a></p>
</body>
</html>`;
}
}
// å¤„ç†æ¨¡æ¿æ¡ä»¶è¯­å¥
function processTemplateConditionals(content, data) {
// å¤„ç† {{#if variable}} ... {{/if}}
const ifRegex = /\{\{#if\s+(\w+)\}\}([\s\S]*?)\{\{\/if\}\}/g;
content = content.replace(ifRegex, (match, variable, innerContent) => {
return data[variable] ? innerContent : '';
});
// å¤„ç† {{#unless variable}} ... {{/unless}}
const unlessRegex = /\{\{#unless\s+(\w+)\}\}([\s\S]*?)\{\{\/unless\}\}/g;
content = content.replace(unlessRegex, (match, variable, innerContent) => {
return !data[variable] ? innerContent : '';
});
// å¤„ç† {{#if (eq variable value)}} ... {{/if}}
const eqRegex = /\{\{#if\s+\(eq\s+(\w+)\s+"([^"]+)"\)\}\}([\s\S]*?)\{\{\/if\}\}/g;
content = content.replace(eqRegex, (match, variable, value, innerContent) => {
return data[variable] === value ? innerContent : '';
});
return content;
}
// å¤‡ç”¨æ¨¡æ¿ç”Ÿæˆå‡½æ•°
function buildFallbackPageContent(post) {
return `<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>${escapeHtml(post.title)} | zcfi.cn</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
body { font-family: 'Noto Sans SC', sans-serif; background: #f5f5f5; margin: 0; padding: 0; }
.container { max-width: 800px; margin: 0 auto; padding: 20px; }
.article-card { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
.article-title { font-size: 2rem; color: #333; margin-bottom: 20px; }
.article-meta { color: #666; margin-bottom: 30px; display: flex; gap: 20px; }
.article-content { line-height: 1.8; font-size: 1.1rem; }
</style>
</head>
<body>
<div class="container">
<div class="article-card">
<h1 class="article-title">${escapeHtml(post.title)}</h1>
<div class="article-meta">
<span><i class="fas fa-calendar"></i> ${escapeHtml(post.date || '')}</span>
<span><i class="fas fa-hashtag"></i> ${escapeHtml(post.id)}</span>
</div>
<div class="article-content">
${post.content || '<p>æš‚æ— å†…å®¹</p>'}
</div>
<p style="margin-top: 30px;"><a href="../blog.html"><i class="fas fa-arrow-left"></i> è¿”å›åšå®¢åˆ—è¡¨</a></p>
</div>
</div>
</body>
</html>`;
}
// åˆ é™¤é¡µé¢æ–‡ä»¶
async function deletePageFile(postId) {
if (!hasRepoPermission) {
console.log('ç¼ºå°‘repoæƒé™ï¼Œè·³è¿‡åˆ é™¤é¡µé¢æ–‡ä»¶');
return;
}
try {
const filePath = `blogs/${postId}.html`;
const checkUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${filePath}?ref=${REPO_BRANCH}`;
const checkResponse = await fetchWithRetry(checkUrl, {
headers: {
'Authorization': `token ${token}`,
'Accept': 'application/vnd.github.v3+json'
}
});
if (!checkResponse.ok) {
console.log('æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— éœ€åˆ é™¤');
return;
}
const currentFile = await checkResponse.json();
const apiUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${filePath}`;
const response = await fetchWithRetry(apiUrl, {
method: 'DELETE',
headers: {
'Authorization': `token ${token}`,
'Accept': 'application/vnd.github.v3+json',
'Content-Type': 'application/json'
},
body: JSON.stringify({
message: `Delete blog page: ${postId}`,
sha: currentFile.sha,
branch: REPO_BRANCH
})
});
if (!response.ok) {
const errorData = await response.json();
console.error(`åˆ é™¤é¡µé¢æ–‡ä»¶å¤±è´¥: ${response.status} ${errorData.message}`);
}
} catch (error) {
console.error('åˆ é™¤é¡µé¢æ–‡ä»¶å¤±è´¥:', error);
}
}
// æ¨¡æ¿ç®¡ç†åŠŸèƒ½
async function manageTemplate() {
try {
showLoading('æ¨¡æ¿ç®¡ç†', 'æ­£åœ¨åŠ è½½æ¨¡æ¿...');
const templateContent = await fetchTemplateFile();
document.getElementById('templateContent').value = templateContent;
hideLoading();
showModal('templateModal');
} catch (error) {
hideLoading();
showResult('error', 'æ¨¡æ¿ç®¡ç†', error.message);
}
}
function closeTemplateModal() {
hideModal('templateModal');
}
async function saveTemplate() {
try {
const templateContent = document.getElementById('templateContent').value;
if (!templateContent.trim()) {
showResult('error', 'ä¿å­˜å¤±è´¥', 'æ¨¡æ¿å†…å®¹ä¸èƒ½ä¸ºç©º');
return;
}
showLoading('ä¿å­˜æ¨¡æ¿', 'æ­£åœ¨ä¿å­˜æ¨¡æ¿æ–‡ä»¶...');
const contentBase64 = btoa(unescape(encodeURIComponent(templateContent)));
let currentFile = null;
let fileExists = false;
try {
const checkUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${TEMPLATE_PATH}`;
const checkResponse = await fetchWithRetry(checkUrl, {
headers: {
'Authorization': `token ${token}`,
'Accept': 'application/vnd.github.v3+json'
}
});
if (checkResponse.ok) {
currentFile = await checkResponse.json();
fileExists = true;
}
} catch (error) {
fileExists = false;
}
const requestData = {
message: 'Update blog page template',
content: contentBase64,
branch: REPO_BRANCH
};
if (fileExists && currentFile && currentFile.sha) {
requestData.sha = currentFile.sha;
}
const apiUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${TEMPLATE_PATH}`;
const response = await fetchWithRetry(apiUrl, {
method: 'PUT',
headers: {
'Authorization': `token ${token}`,
'Accept': 'application/vnd.github.v3+json',
'Content-Type': 'application/json'
},
body: JSON.stringify(requestData)
});
if (!response.ok) {
throw new Error('ä¿å­˜æ¨¡æ¿å¤±è´¥');
}
hideLoading();
showResult('success', 'ä¿å­˜æˆåŠŸ', 'æ¨¡æ¿å·²ä¿å­˜');
closeTemplateModal();
} catch (error) {
hideLoading();
showResult('error', 'ä¿å­˜å¤±è´¥', error.message);
}
}
// å¸¦é‡è¯•æœºåˆ¶çš„fetch
async function fetchWithRetry(url, options = {}, retryCount = 0) {
const maxRetries = CORS_PROXIES.length;
try {
if (retryCount === 0) {
try {
const directResponse = await fetch(url, options);
if (directResponse.ok || directResponse.status !== 0) {
return directResponse;
}
} catch (directError) {
console.log('ç›´æ¥è¯·æ±‚å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ä»£ç†');
}
}
if (retryCount < maxRetries) {
const proxyUrl = CORS_PROXIES[retryCount];
let fullUrl;
if (proxyUrl.includes('allorigins')) {
fullUrl = `${proxyUrl}${encodeURIComponent(url)}`;
} else if (proxyUrl.includes('corsproxy.io')) {
fullUrl = `${proxyUrl}${encodeURIComponent(url)}`;
} else if (proxyUrl.includes('codetabs')) {
fullUrl = `${proxyUrl}${encodeURIComponent(url)}`;
}
console.log(`å°è¯•ä»£ç† ${retryCount + 1}/${maxRetries}: ${proxyUrl}`);
const proxyResponse = await fetch(fullUrl, options);
if (proxyResponse.ok) {
return proxyResponse;
} else {
const errorText = await proxyResponse.text();
console.warn(`ä»£ç† ${retryCount + 1} è¿”å›é”™è¯¯:`, proxyResponse.status, errorText);
throw new Error(`HTTP ${proxyResponse.status}`);
}
} else {
throw new Error('æ‰€æœ‰CORSä»£ç†éƒ½å¤±è´¥');
}
} catch (error) {
if (retryCount < maxRetries - 1) {
const delayTime = 500 * (retryCount + 1);
console.log(`ç­‰å¾… ${delayTime}ms åé‡è¯•...`);
await new Promise(resolve => setTimeout(resolve, delayTime));
return await fetchWithRetry(url, options, retryCount + 1);
} else {
throw error;
}
}
}
// ç¡®è®¤å¼¹çª—
function showConfirm(title, message, action, data = null) {
pendingAction = action;
pendingActionData = data;
document.getElementById('confirmTitle').textContent = title;
document.getElementById('confirmMessage').textContent = message;
showModal('confirmModal');
}
function closeConfirmModal() {
hideModal('confirmModal');
pendingAction = null;
pendingActionData = null;
}
function closePermissionDetailsModal() {
hideModal('permissionDetailsModal');
}
function executeConfirmedAction() {
if (pendingAction) {
pendingAction(pendingActionData);
closeConfirmModal();
}
}
// åŠ è½½å¼¹çª—
function showLoading(title = 'å¤„ç†ä¸­', message = 'æ­£åœ¨å¤„ç†æ‚¨çš„è¯·æ±‚ï¼Œè¯·ç¨å€™...') {
document.getElementById('loadingTitle').textContent = title;
document.getElementById('loadingMessage').textContent = message;
showModal('loadingModal');
}
function hideLoading() {
hideModal('loadingModal');
}
// ç»“æœå¼¹çª—
function showResult(type, title, message) {
const icon = document.getElementById('resultIcon');
if (type === 'success') {
icon.className = 'fas fa-check-circle';
icon.style.color = '#28a745';
} else if (type === 'error') {
icon.className = 'fas fa-exclamation-circle';
icon.style.color = '#dc3545';
} else {
icon.className = 'fas fa-info-circle';
icon.style.color = '#4a6fa5';
}
document.getElementById('resultTitle').textContent = title;
document.getElementById('resultMessage').textContent = message;
showModal('resultModal');
}
function closeResultModal() {
hideModal('resultModal');
}
// é€šç”¨å¼¹çª—æ§åˆ¶
function showModal(modalId) {
document.getElementById(modalId).classList.add('show');
}
function hideModal(modalId) {
document.getElementById(modalId).classList.remove('show');
}
function closeAllModals() {
document.querySelectorAll('.custom-modal.show').forEach(modal => {
modal.classList.remove('show');
});
pendingAction = null;
pendingActionData = null;
}
// æ–‡ç« æ“ä½œå‡½æ•°
async function saveArticle() {
const editPostId = document.getElementById('editPostId').value;
const postId = document.getElementById('postId').value.trim();
const title = document.getElementById('title').value.trim();
const date = document.getElementById('date').value.trim();
const customUrl = document.getElementById('customUrl').value.trim();
const status = document.getElementById('status').value;
const excerpt = document.getElementById('excerpt').value.trim();
const content = document.getElementById('content').value.trim();
if (!postId || !title || !date || !excerpt || !content) {
showResult('error', 'è¾“å…¥é”™è¯¯', 'è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
return;
}
try {
showLoading('ä¿å­˜æ–‡ç« ', editPostId ? 'æ­£åœ¨æ›´æ–°æ–‡ç« ...' : 'æ­£åœ¨ä¿å­˜æ–‡ç« ...');
const currentData = await fetchCurrentData();
if (!editPostId) {
if (currentData.some(post => post.id === postId)) {
throw new Error('æ–‡ç«  ID å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨ä¸åŒçš„ ID');
}
const newPost = {
id: postId,
title: title,
date: date,
customUrl: customUrl || '',
status: status,
excerpt: excerpt,
content: content,
author: '',
tags: [],
enabled: true,
lastUpdated: date,
generatePage: false,
seoKeywords: '',
seoDescription: ''
};
currentData.unshift(newPost);
} else {
const postIndex = currentData.findIndex(post => post.id === editPostId);
if (postIndex === -1) {
throw new Error('æœªæ‰¾åˆ°æŒ‡å®šæ–‡ç« ');
}
const otherPost = currentData.find(post => post.id === postId && post.id !== editPostId);
if (otherPost) {
throw new Error('æ–‡ç«  ID å·²è¢«å…¶ä»–æ–‡ç« ä½¿ç”¨');
}
const oldPost = currentData[postIndex];
currentData[postIndex] = {
id: postId,
title: title,
date: date,
customUrl: customUrl || '',
status: status,
excerpt: excerpt,
content: content,
author: oldPost.author || '',
tags: oldPost.tags || [],
enabled: oldPost.enabled !== false,
lastUpdated: date,
generatePage: oldPost.generatePage || false,
seoKeywords: oldPost.seoKeywords || '',
seoDescription: oldPost.seoDescription || ''
};
}
await updateGistData(currentData);
hideLoading();
showResult('success', 'æ“ä½œæˆåŠŸ', editPostId ? 'æ–‡ç« æ›´æ–°æˆåŠŸï¼' : 'æ–‡ç« ä¿å­˜æˆåŠŸï¼');
closeArticleModal();
loadBlogData(false, false);
} catch (error) {
hideLoading();
showResult('error', 'æ“ä½œå¤±è´¥', error.message);
}
}
async function toggleArticleStatus(postId, currentStatus) {
const newStatus = currentStatus === 'published' ? 'draft' : 'published';
const actionText = newStatus === 'published' ? 'ä¸Šæ¶' : 'ä¸‹æ¶';
try {
showLoading('æ›´æ–°çŠ¶æ€', 'æ­£åœ¨æ›´æ–°æ–‡ç« çŠ¶æ€...');
const currentData = await fetchCurrentData();
const postIndex = currentData.findIndex(post => post.id === postId);
if (postIndex === -1) {
throw new Error('æœªæ‰¾åˆ°æŒ‡å®šæ–‡ç« ');
}
if (currentData[postIndex].generatePage && newStatus === 'draft') {
await deletePageFile(postId);
}
currentData[postIndex].status = newStatus;
currentData[postIndex].lastUpdated = new Date().toISOString().split('T')[0];
await updateGistData(currentData);
hideLoading();
showResult('success', 'æ“ä½œæˆåŠŸ', `æ–‡ç« å·²${actionText}`);
loadBlogData(false, false);
} catch (error) {
hideLoading();
showResult('error', 'æ“ä½œå¤±è´¥', error.message);
}
}
async function deleteArticle(postId) {
try {
showLoading('åˆ é™¤æ–‡ç« ', 'æ­£åœ¨åˆ é™¤æ–‡ç« ...');
const currentData = await fetchCurrentData();
const postIndex = currentData.findIndex(post => post.id === postId);
if (postIndex === -1) {
throw new Error('æœªæ‰¾åˆ°æŒ‡å®šæ–‡ç« ');
}
if (currentData[postIndex].generatePage) {
await deletePageFile(postId);
}
const filteredData = currentData.filter(post => post.id !== postId);
await updateGistData(filteredData);
hideLoading();
showResult('success', 'æ“ä½œæˆåŠŸ', 'æ–‡ç« åˆ é™¤æˆåŠŸï¼');
loadBlogData(false, false);
} catch (error) {
hideLoading();
showResult('error', 'æ“ä½œå¤±è´¥', error.message);
}
}
// æ•°æ®æ“ä½œå‡½æ•°
async function fetchCurrentData() {
const response = await fetchWithRetry(GIST_URL, {
headers: {
'Authorization': `token ${token}`,
'Accept': 'application/vnd.github.v3+json'
}
});
if (!response.ok) {
throw new Error(`è·å–æ•°æ®å¤±è´¥: ${response.status} ${response.statusText}`);
}
const gist = await response.json();
const data = JSON.parse(gist.files['blog.json'].content);
let blogData;
if (Array.isArray(data)) {
blogData = data;
} else if (data && typeof data === 'object' && Array.isArray(data.blog)) {
blogData = data.blog;
} else {
throw new Error('æ•°æ®æ ¼å¼æ— æ•ˆ');
}
return blogData.map(post => ({
...post,
status: post.status || 'published',
customUrl: post.customUrl || '',
author: post.author || '',
tags: post.tags || [],
enabled: post.enabled !== false,
lastUpdated: post.lastUpdated || post.date || '',
generatePage: post.generatePage || false,
seoKeywords: post.seoKeywords || '',
seoDescription: post.seoDescription || ''
}));
}
async function updateGistData(newData) {
const updateResponse = await fetchWithRetry(GIST_URL, {
method: 'PATCH',
headers: {
'Authorization': `token ${token}`,
'Accept': 'application/vnd.github.v3+json',
'Content-Type': 'application/json'
},
body: JSON.stringify({
files: {
'blog.json': {
content: JSON.stringify(newData, null, 2)
}
}
})
});
if (!updateResponse.ok) {
const errorText = await updateResponse.text();
throw new Error(`æ›´æ–°å¤±è´¥: ${updateResponse.status} ${errorText}`);
}
}
// ä¸»åŠ è½½å‡½æ•°
async function loadBlogData(isInitialLoad = false, showRefreshResult = false) {
try {
if (!isInitialLoad && showRefreshResult) {
showLoading('åˆ·æ–°æ–‡ç« ', 'æ­£åœ¨ä»æœåŠ¡å™¨è·å–æœ€æ–°æ–‡ç« åˆ—è¡¨...');
}
const beforeCount = currentBlogData.length;
const data = await fetchCurrentData();
currentBlogData = data;
displayArticlesList(data);
const afterCount = data.length;
const changeCount = afterCount - beforeCount;
if (!isInitialLoad && showRefreshResult) {
hideLoading();
let message = '';
if (changeCount > 0) {
message = `åˆ·æ–°å®Œæˆï¼æ–°å¢ ${changeCount} ç¯‡æ–‡ç« ï¼Œç°åœ¨å…±æœ‰ ${afterCount} ç¯‡æ–‡ç« ã€‚`;
} else if (changeCount < 0) {
message = `åˆ·æ–°å®Œæˆï¼åˆ é™¤äº† ${Math.abs(changeCount)} ç¯‡æ–‡ç« ï¼Œç°åœ¨å…±æœ‰ ${afterCount} ç¯‡æ–‡ç« ã€‚`;
} else {
message = `åˆ·æ–°å®Œæˆï¼æ–‡ç« æ•°é‡æ— å˜åŒ–ï¼Œå…±æœ‰ ${afterCount} ç¯‡æ–‡ç« ã€‚`;
}
showResult('success', 'åˆ·æ–°æˆåŠŸ', message);
} else if (!isInitialLoad && !showRefreshResult) {
hideLoading();
}
} catch (error) {
console.error('åŠ è½½æ–‡ç« å¤±è´¥:', error);
if (!isInitialLoad) {
hideLoading();
if (showRefreshResult) {
showResult('error', 'åˆ·æ–°å¤±è´¥', `åˆ·æ–°æ–‡ç« åˆ—è¡¨å¤±è´¥: ${error.message}`);
}
} else {
document.getElementById('articlesCount').textContent = 'åŠ è½½å¤±è´¥';
document.getElementById('articlesList').innerHTML = `
<div class="admin-card">
<p style="color: #dc3545;">âŒ ${error.message}</p>
<p>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒTokenæƒé™ï¼Œç„¶åç‚¹å‡»åˆ·æ–°æŒ‰é’®é‡è¯•</p>
</div>
`;
}
}
}
function suggestNextPostId(data) {
if (data.length === 0) {
document.getElementById('postId').value = 'post1';
return;
}
let maxNum = 0;
data.forEach(post => {
if (post.id && post.id.startsWith('post')) {
const num = parseInt(post.id.replace('post', ''));
if (!isNaN(num) && num > maxNum) {
maxNum = num;
}
}
});
document.getElementById('postId').value = `post${maxNum + 1}`;
}
function displayArticlesList(data) {
const container = document.getElementById('articlesList');
const countElement = document.getElementById('articlesCount');
countElement.textContent = `${data.length} ç¯‡æ–‡ç« `;
if (data.length === 0) {
container.innerHTML = `
<div class="empty-state">
<i class="fas fa-file-alt"></i>
<h3>æš‚æ— æ–‡ç« </h3>
<p>ç‚¹å‡»"æ·»åŠ æ–°æ–‡ç« "æŒ‰é’®å¼€å§‹åˆ›å»ºç¬¬ä¸€ç¯‡åšå®¢æ–‡ç« </p>
</div>
`;
return;
}
container.innerHTML = data.map(post => `
<div class="admin-card" data-post-id="${post.id}">
<div class="admin-card-header">
<div>
<div class="admin-card-title">${escapeHtml(post.title)}</div>
<div class="article-meta">
<span><i class="fas fa-hashtag"></i> ID: ${escapeHtml(post.id)}</span>
<span><i class="fas fa-calendar"></i> ${escapeHtml(post.date)}</span>
${post.customUrl ? `<span><i class="fas fa-link"></i> ${escapeHtml(post.customUrl)}</span>` : ''}
${post.author ? `<span><i class="fas fa-user"></i> ${escapeHtml(post.author)}</span>` : ''}
${post.tags && post.tags.length > 0 ? `<span><i class="fas fa-tags"></i> ${escapeHtml(post.tags.join(', '))}</span>` : ''}
</div>
</div>
<div>
<span class="article-status status-${post.status}">
${post.status === 'published' ? 'å·²å‘å¸ƒ' : 'è‰ç¨¿'}
</span>
${post.generatePage ? `<span class="article-status status-page-generated">
<i class="fas fa-file-code"></i> å·²ç”Ÿæˆé¡µé¢
</span>` : ''}
${post.enabled === false ? `<span class="article-status" style="background-color: #dc3545; color: white;">
<i class="fas fa-ban"></i> å·²ç¦ç”¨
</span>` : ''}
</div>
</div>
<p>${escapeHtml(post.excerpt.substring(0, 150))}${post.excerpt.length > 150 ? '...' : ''}</p>
<div class="action-buttons">
<button class="admin-btn btn-primary action-btn edit-btn" data-post-id="${post.id}">
<i class="fas fa-edit"></i> ç¼–è¾‘
</button>
${post.status === 'published' ?
`<button class="admin-btn btn-warning action-btn toggle-status-btn" data-post-id="${post.id}" data-current-status="${post.status}">
<i class="fas fa-eye-slash"></i> ä¸‹æ¶
</button>` :
`<button class="admin-btn btn-success action-btn toggle-status-btn" data-post-id="${post.id}" data-current-status="${post.status}">
<i class="fas fa-eye"></i> ä¸Šæ¶
</button>`}
<button class="admin-btn btn-danger action-btn delete-btn" data-post-id="${post.id}">
<i class="fas fa-trash"></i> åˆ é™¤
</button>
${hasRepoPermission ? `
<button class="advanced-btn" data-post-id="${post.id}" title="é«˜çº§é…ç½®ï¼ˆé¡µé¢ç”Ÿæˆã€SEOç­‰ï¼‰">
<i class="fas fa-cog"></i> é«˜çº§é…ç½®
</button>
` : `
<button class="advanced-btn" disabled title="éœ€è¦Repoæƒé™æ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½">
<i class="fas fa-lock"></i> é«˜çº§é…ç½®
</button>
`}
</div>
</div>
`).join('');
attachArticleEventListeners();
}
function attachArticleEventListeners() {
document.querySelectorAll('.edit-btn').forEach(btn => {
btn.addEventListener('click', function() {
const postId = this.getAttribute('data-post-id');
openEditModal(postId);
});
});
document.querySelectorAll('.toggle-status-btn').forEach(btn => {
btn.addEventListener('click', function() {
const postId = this.getAttribute('data-post-id');
const currentStatus = this.getAttribute('data-current-status');
const actionText = currentStatus === 'published' ? 'ä¸‹æ¶' : 'ä¸Šæ¶';
showConfirm(
`${actionText}æ–‡ç« `,
`ç¡®å®šè¦å°†æ–‡ç«  ${postId} ${actionText}å—ï¼Ÿ`,
() => toggleArticleStatus(postId, currentStatus)
);
});
});
document.querySelectorAll('.delete-btn').forEach(btn => {
btn.addEventListener('click', function() {
const postId = this.getAttribute('data-post-id');
showConfirm(
'åˆ é™¤æ–‡ç« ',
`ç¡®å®šè¦åˆ é™¤æ–‡ç«  ${postId} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`,
() => deleteArticle(postId)
);
});
});
document.querySelectorAll('.advanced-btn:not([disabled])').forEach(btn => {
btn.addEventListener('click', function() {
const postId = this.getAttribute('data-post-id');
openAdvancedConfigModal(postId);
});
});
}
// è¾…åŠ©å‡½æ•°
function escapeHtml(text) {
if (!text) return '';
const div = document.createElement('div');
div.textContent = text;
return div.innerHTML;
}
// é¡µé¢å¸è½½æ—¶æ¸…é™¤æ•æ„Ÿä¿¡æ¯
window.addEventListener('beforeunload', () => {
sessionStorage.removeItem('admin_token');
sessionStorage.removeItem('admin_verified');
});
</script>
</body>
</html>
