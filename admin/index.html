<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>管理后台 | zcfi.cn</title>
<!-- Favicon -->
<link rel="icon" type="image/svg+xml" href="../favicon/favicon.svg">
<link rel="icon" type="image/png" sizes="96x96" href="../favicon/favicon-96x96.png">
<link rel="icon" type="image/x-icon" href="../favicon/favicon.ico">
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- 后台公共CSS -->
<link rel="stylesheet" href="assets/css/admin-common.css">
<style>
/* 登录页面特定样式 */
.login-container {
  background: white;
  border-radius: 20px;
  box-shadow: 0 15px 50px rgba(0,0,0,0.3);
  width: 100%;
  max-width: 600px;
  padding: 40px;
  text-align: center;
}
.login-logo {
  font-size: 36px;
  font-weight: 700;
  color: #4a6fa5;
  margin-bottom: 30px;
  text-decoration: none;
  display: inline-block;
}
.login-logo span {
  color: #28a745;
}
.login-title {
  color: #333;
  margin-bottom: 25px;
  font-size: 24px;
}
.token-input {
  position: relative;
  margin-bottom: 30px;
}
.token-input input {
  width: 100%;
  padding: 15px 20px;
  border: 2px solid #dee2e6;
  border-radius: 12px;
  font-size: 16px;
  transition: all 0.3s ease;
}
.token-input input:focus {
  outline: none;
  border-color: #4a6fa5;
  box-shadow: 0 0 0 4px rgba(74, 111, 165, 0.15);
}
.modules-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
  margin-top: 30px;
}
.module-card {
  background: #f8f9fa;
  border: 2px solid #e9ecef;
  border-radius: 15px;
  padding: 25px 15px;
  cursor: pointer;
  transition: all 0.3s ease;
  text-align: center;
}
.module-card:hover {
  transform: translateY(-5px);
  border-color: #4a6fa5;
  box-shadow: 0 8px 20px rgba(74, 111, 165, 0.2);
  background: #ffffff;
}
.module-card.selected {
  border-color: #4a6fa5;
  background: #ffffff;
  box-shadow: 0 8px 20px rgba(74, 111, 165, 0.25);
}
.module-icon {
  font-size: 32px;
  color: #4a6fa5;
  margin-bottom: 15px;
  transition: transform 0.3s ease;
}
.module-card:hover .module-icon {
  transform: scale(1.2);
}
.module-title {
  font-weight: 600;
  color: #333;
  font-size: 16px;
}
.module-description {
  font-size: 13px;
  color: #6c757d;
  margin-top: 8px;
  line-height: 1.4;
  min-height: 36px;
}
.login-btn {
  width: 100%;
  padding: 16px;
  background: #4a6fa5;
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 18px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  margin-top: 25px;
}
.login-btn:hover {
  background: #3a5a80;
  transform: translateY(-2px);
}
.login-btn:disabled {
  background: #6c757d;
  cursor: not-allowed;
  transform: none;
}
/* 权限显示样式 */
.permissions-section {
  margin-top: 20px;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 8px;
  text-align: left;
}
.permission-item {
  display: flex;
  align-items: center;
  margin-bottom: 8px;
}
.permission-icon {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 10px;
  font-size: 14px;
}
.permission-granted {
  background-color: #28a745;
  color: white;
}
.permission-denied {
  background-color: #dc3545;
  color: white;
}
.permission-name {
  font-weight: 500;
}
/* Token状态提示样式 */
.token-status-section {
  margin-top: 20px;
  padding: 15px;
  border-radius: 8px;
  background: #e3f2fd;
  border: 1px solid #bbdefb;
}
.token-status-warning {
  background: #fff8e1;
  border-color: #ffecb3;
}
.token-status-alert {
  background: #ffebee;
  border-color: #ffcdd2;
}
.status-label {
  font-weight: 600;
  margin-bottom: 5px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.status-message {
  font-size: 14px;
  line-height: 1.5;
}
.status-good {
  color: #28a745;
}
.status-warning {
  color: #ffc107;
}
.status-bad {
  color: #dc3545;
}
/* 响应式调整 */
@media (max-width: 768px) {
  .modules-grid {
    grid-template-columns: 1fr;
  }
}
/* 修正：表单容器 */
.login-form {
  width: 100%;
}
</style>
</head>
<body class="admin-body">
<div class="admin-container" style="max-width: 600px;">
  <div class="login-container">
    <a href="https://zcfi.cn" class="login-logo">zcfi<span>.</span>cn</a>
    <h2 class="login-title"><i class="fas fa-lock"></i> 管理后台登录</h2>
    <!-- 修正：将表单元素包裹在form标签内 -->
    <form class="login-form" id="loginForm">
      <div class="token-input">
        <input type="password" id="token" placeholder="请输入 GitHub Personal Access Token (ghp_xxx...)" autocomplete="off">
      </div>
      <div class="modules-grid">
        <!-- 博客管理 -->
        <div class="module-card" data-module="blog">
          <div class="module-icon">
            <i class="fas fa-blog"></i>
          </div>
          <div class="module-title">博客管理</div>
          <div class="module-description">管理博客文章，编辑发布新内容</div>
        </div>
        <!-- 作品集管理 -->
        <div class="module-card" data-module="portfolio">
          <div class="module-icon">
            <i class="fas fa-briefcase"></i>
          </div>
          <div class="module-title">作品集管理</div>
          <div class="module-description">管理项目作品，设置首页展示</div>
        </div>
        <!-- 留言管理 -->
        <div class="module-card" data-module="contact">
          <div class="module-icon">
            <i class="fas fa-comments"></i>
          </div>
          <div class="module-title">留言管理</div>
          <div class="module-description">查看和处理访客留言</div>
        </div>
        <!-- 配置面板 -->
        <div class="module-card" data-module="config">
          <div class="module-icon">
            <i class="fas fa-cog"></i>
          </div>
          <div class="module-title">配置面板</div>
          <div class="module-description">网站设置和法律声明配置</div>
        </div>
      </div>
      <button class="login-btn" id="enterBtn" disabled>
        <i class="fas fa-sign-in-alt"></i> 进入管理
      </button>
    </form>
    <!-- Token使用说明 -->
    <div style="margin-top: 25px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 14px; color: #6c757d;">
      <p style="margin-bottom: 8px;"><i class="fas fa-info-circle" style="color: #4a6fa5;"></i> <strong>Token 说明：</strong></p>
      <p style="font-size: 13px; line-height: 1.5;">
        1. 前往 <a href="https://github.com/settings/tokens" target="_blank" style="color: #4a6fa5; text-decoration: none;">GitHub Token设置</a> 创建新Token<br>
        2. 基础功能需要勾选 <code>gist</code> 权限<br>
        3. 高级功能（如自动生成博客页面）需要额外勾选 <code>repo</code> 权限<br>
        4. Token格式：<code>ghp_xxxxxxxxxxxx</code><br>
        5. Token安全存储，切勿泄露
      </p>
    </div>
  </div>
</div>
<!-- 使用公共弹窗样式 -->
<div class="custom-modal" id="customModal">
  <div class="modal-content">
    <div class="modal-header">
      <i class="fas fa-info-circle"></i>
    </div>
    <div class="modal-title">提示</div>
    <div class="modal-message" id="modalMessage">消息内容</div>
    <div class="modal-buttons">
      <button class="modal-btn btn-primary" id="modalConfirmBtn">确定</button>
      <button class="modal-btn btn-secondary" id="modalCancelBtn" style="display:none;">取消</button>
    </div>
  </div>
</div>
<!-- 权限确认弹窗 -->
<div class="custom-modal" id="permissionsModal">
  <div class="modal-content">
    <div class="modal-header">
      <i class="fas fa-shield-alt"></i>
    </div>
    <div class="modal-title" id="permissionsModalTitle">权限验证结果</div>
    <div class="modal-message">
      <p id="permissionsModalMessage">您的Token权限验证已完成，以下是详细信息：</p>
      <div class="permissions-section" id="permissionsList">
        <!-- 权限列表将在这里动态生成 -->
      </div>
      <!-- Token状态信息显示区域 -->
      <div id="tokenStatusSectionContainer">
        <!-- Token状态信息将在这里动态生成 -->
      </div>
      <p style="margin-top: 15px; font-weight: 500;">请注意：</p>
      <ul style="text-align: left; margin-top: 10px; margin-bottom: 20px;">
        <li>缺少<span style="color: #dc3545; font-weight: 600;">gist</span>权限将无法使用任何后台功能</li>
        <li>缺少<span style="color: #4a6fa5; font-weight: 600;">repo</span>权限将无法使用<span style="color: #4a6fa5;">自动生成博客页面</span>等高级功能</li>
        <li>Token 过期后需要重新生成并登录，建议定期更换 Token 以确保安全</li>
      </ul>
      <p style="text-align: left; margin-top: 10px;">
        您可以在 <a href="https://github.com/settings/tokens" target="_blank" style="color: #4a6fa5; text-decoration: none;">GitHub Token设置页面</a> 
        查看Token有效期、修改权限或创建新Token。
      </p>
    </div>
    <div class="modal-buttons">
      <button class="modal-btn btn-secondary" id="permissionsCancelBtn">返回修改</button>
      <button class="modal-btn btn-primary" id="permissionsConfirmBtn">确认并继续</button>
    </div>
  </div>
</div>
<script>
let selectedModule = null;
const BLOG_GIST_ID = '73cc78400c25eb9effed665e2c89843d';
const GIST_URL = `https://api.github.com/gists/${BLOG_GIST_ID}`;
const SCOPE_CHECK_URL = 'https://api.github.com';

// 页面加载
document.addEventListener('DOMContentLoaded', () => {
  setupEventListeners();
});

// 初始化事件监听器
function setupEventListeners() {
  // 防止表单默认提交
  document.getElementById('loginForm').addEventListener('submit', function(e) {
    e.preventDefault();
    if (!document.getElementById('enterBtn').disabled && selectedModule) {
      validateAndLogin();
    }
  });
  
  // 模块选择
  document.querySelectorAll('.module-card').forEach(card => {
    card.addEventListener('click', function() {
      document.querySelectorAll('.module-card').forEach(c => c.classList.remove('selected'));
      this.classList.add('selected');
      selectedModule = this.dataset.module;
      updateEnterButton();
    });
  });
  
  // Token 输入
  document.getElementById('token').addEventListener('input', updateEnterButton);
  
  // 进入按钮
  document.getElementById('enterBtn').addEventListener('click', validateAndLogin);
  
  // 弹窗按钮
  document.getElementById('modalConfirmBtn').addEventListener('click', closeModal);
  document.getElementById('modalCancelBtn').addEventListener('click', closeModal);
  
  // 权限弹窗按钮
  document.getElementById('permissionsCancelBtn').addEventListener('click', closePermissionsModal);
  document.getElementById('permissionsConfirmBtn').addEventListener('click', confirmPermissionsAndNavigate);
}

// 更新按钮状态
function updateEnterButton() {
  const token = document.getElementById('token').value.trim();
  const btn = document.getElementById('enterBtn');
  btn.disabled = !(token && selectedModule);
}

// 检查Token权限
async function checkTokenPermissions(token) {
  const permissions = {
    gist: false,
    repo: false
  };
  
  try {
    // 1. 检查gist权限
    const gistResponse = await fetch(GIST_URL, {
      headers: {
        'Authorization': `token ${token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });
    
    if (gistResponse.ok) {
      permissions.gist = true;
    }
  } catch (error) {
    console.error('检查gist权限失败:', error);
  }
  
  try {
    // 2. 检查repo权限 - 从响应头获取scope信息
    const scopeResponse = await fetch(SCOPE_CHECK_URL, {
      headers: {
        'Authorization': `token ${token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });
    
    if (scopeResponse.ok) {
      const scopesHeader = scopeResponse.headers.get('x-oauth-scopes');
      if (scopesHeader) {
        const scopes = scopesHeader.split(',').map(scope => scope.trim());
        console.log('Token scopes:', scopes);
        permissions.repo = scopes.some(scope => 
          scope === 'repo' || 
          scope.startsWith('repo:') || 
          scope.includes('write')
        );
      }
    }
  } catch (error) {
    console.error('检查repo权限失败:', error);
  }
  
  return permissions;
}

// 检查Token状态（是否有效）
async function checkTokenStatus(token) {
  try {
    // 尝试获取用户信息来验证token状态
    const response = await fetch('https://api.github.com/user', {
      headers: {
        'Authorization': `token ${token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });
    
    if (!response.ok) {
      // Token无效或权限不足
      return {
        isValid: false,
        status: 'invalid',
        message: `Token无效或权限不足。状态码: ${response.status} ${response.statusText}`
      };
    }
    
    // 检查速率限制
    const rateLimitRemaining = response.headers.get('x-ratelimit-remaining');
    const rateLimitReset = response.headers.get('x-ratelimit-reset');
    
    if (rateLimitRemaining !== null && parseInt(rateLimitRemaining) === 0) {
      const resetTime = new Date(parseInt(rateLimitReset) * 1000);
      const now = new Date();
      const minutesUntilReset = Math.ceil((resetTime - now) / (1000 * 60));
      
      if (minutesUntilReset > 0) {
        return {
          isValid: true,
          status: 'rate_limited',
          message: `Token当前被速率限制，将在约${minutesUntilReset}分钟后恢复。请稍后再试或联系GitHub支持。`
        };
      }
    }
    
    // Token状态良好
    return {
      isValid: true,
      status: 'good',
      message: 'Token当前有效，可以正常使用所有授权功能。'
    };
  } catch (error) {
    console.error('检查Token状态失败:', error);
    return {
      isValid: false,
      status: 'error',
      message: '无法验证Token状态，请检查网络连接或Token是否正确。'
    };
  }
}

// 渲染Token状态信息
function renderTokenStatusInfo(statusInfo) {
  const container = document.getElementById('tokenStatusSectionContainer');
  
  let iconClass, iconType, titleText, messageText, statusClass;
  
  if (statusInfo.status === 'good') {
    iconClass = 'status-good';
    iconType = 'fa-check-circle';
    titleText = 'Token 状态: 正常';
    messageText = statusInfo.message;
    statusClass = 'token-status-section';
  } else if (statusInfo.status === 'rate_limited') {
    iconClass = 'status-warning';
    iconType = 'fa-exclamation-triangle';
    titleText = 'Token 状态: 速率限制';
    messageText = statusInfo.message;
    statusClass = 'token-status-section token-status-warning';
  } else {
    iconClass = 'status-bad';
    iconType = 'fa-times-circle';
    titleText = 'Token 状态: 无效';
    messageText = statusInfo.message;
    statusClass = 'token-status-section token-status-alert';
  }
  
  // 构建状态显示HTML
  const statusHTML = `
    <div class="${statusClass}" id="tokenStatusSection">
      <p class="status-label">
        <i class="fas ${iconType} ${iconClass}"></i> <span id="statusTitle">${titleText}</span>
      </p>
      <p class="status-message" id="statusMessage">${messageText}</p>
    </div>
  `;
  
  // 直接替换整个状态区域
  container.innerHTML = statusHTML;
}

// 验证和登录
async function validateAndLogin() {
  const token = document.getElementById('token').value.trim();
  
  if (!token.startsWith('ghp_')) {
    closeModal();
    showPermissionsModal({
      gist: false,
      repo: false
    }, {
      isValid: false,
      status: 'invalid',
      message: 'Token 必须以 "ghp_" 开头'
    });
    return;
  }
  
  showLoadingModal('正在验证 Token...');
  
  try {
    // 1. 首先检查Token状态（这是最基础的验证）
    closeModal();
    showLoadingModal('正在检查Token状态...');
    const statusInfo = await checkTokenStatus(token);
    closeModal();

    // 2. 如果Token状态无效，直接显示错误（不再检查权限）
    if (!statusInfo.isValid) {
      showPermissionsModal({
        gist: false,
        repo: false
      }, statusInfo);
      return;
    }

    // 3. Token状态有效，再检查权限
    showLoadingModal('正在检查权限...');
    const permissions = await checkTokenPermissions(token);
    closeModal();

    // 4. 显示权限检查结果
    showPermissionsModal(permissions, statusInfo);

    // 5. 保存token和选择的模块，等待用户确认
    sessionStorage.setItem('pending_admin_token', token);
    sessionStorage.setItem('pending_selected_module', selectedModule);
    sessionStorage.setItem('token_permissions', JSON.stringify(permissions));
  } catch (error) {
    console.error('Token 验证失败:', error);
    closeModal();
    showPermissionsModal({
      gist: false,
      repo: false
    }, {
      isValid: false,
      status: 'invalid',
      message: `Token 无效或无权限访问 Gist\n错误: ${error.message}`
    });
  }
}

// 显示权限弹窗
function showPermissionsModal(permissions, statusInfo) {
  const permissionsList = document.getElementById('permissionsList');
  const modalTitle = document.getElementById('permissionsModalTitle');
  const modalMessage = document.getElementById('permissionsModalMessage');
  const confirmBtn = document.getElementById('permissionsConfirmBtn');
  
  if (statusInfo.isValid) {
    // 验证成功
    modalTitle.textContent = '权限验证结果';
    modalMessage.textContent = '您的Token权限验证已完成，以下是详细信息：';
    confirmBtn.style.display = 'inline-block';
    
    // 构建权限列表HTML
    permissionsList.innerHTML = `
      <div class="permission-item">
        <div class="permission-icon ${permissions.gist ? 'permission-granted' : 'permission-denied'}">
          ${permissions.gist ? '✓' : '✗'}
        </div>
        <div class="permission-name">Gist 权限: ${permissions.gist ? '<span style="color: #28a745;">已授权</span>' : '<span style="color: #dc3545;">未授权</span>'}</div>
      </div>
      <div class="permission-item">
        <div class="permission-icon ${permissions.repo ? 'permission-granted' : 'permission-denied'}">
          ${permissions.repo ? '✓' : '✗'}
        </div>
        <div class="permission-name">仓库 (repo) 权限: ${permissions.repo ? '<span style="color: #28a745;">已授权</span>' : '<span style="color: #dc3545;">未授权</span>'}</div>
      </div>
      <p style="margin-top: 15px; font-size: 13px; color: #6c757d;">
        提示：权限检查基于 GitHub API 返回的 Token 作用域信息。
      </p>
    `;
  } else {
    // 验证失败 - 仅显示Token状态错误，不显示权限信息
    modalTitle.textContent = '验证失败';
    modalMessage.textContent = '无法验证您的Token，请检查以下信息：';
    confirmBtn.style.display = 'none';
    
    permissionsList.innerHTML = `
      <div style="padding: 15px; background: #ffebee; border-radius: 8px; margin-bottom: 15px;">
        <div style="display: flex; align-items: center; margin-bottom: 10px;">
          <div style="width: 24px; height: 24px; border-radius: 50%; background: #dc3545; color: white; display: flex; align-items: center; justify-content: center; margin-right: 10px;">
            <i class="fas fa-exclamation-circle"></i>
          </div>
          <div style="font-weight: 500;">${statusInfo.message}</div>
        </div>
        <div style="font-size: 14px; color: #6c757d;">
          <p style="margin-bottom: 5px;">可能的原因：</p>
          <ul style="margin-left: 20px; margin-top: 5px;">
            <li>Token 格式不正确或已过期</li>
            <li>网络连接问题</li>
            <li>GitHub API 临时限制</li>
            <li>请确保在 <span style="color: #4a6fa5">https://zcfi.cn</span> 域名下访问</li>
          </ul>
        </div>
      </div>
    `;
  }
  
  // 渲染Token状态信息
  renderTokenStatusInfo(statusInfo);
  
  // 显示弹窗
  document.getElementById('permissionsModal').classList.add('show');
}

// 关闭权限弹窗
function closePermissionsModal() {
  document.getElementById('permissionsModal').classList.remove('show');
}

// 确认权限并导航
function confirmPermissionsAndNavigate() {
  closePermissionsModal();
  
  const token = sessionStorage.getItem('pending_admin_token');
  const module = sessionStorage.getItem('pending_selected_module');
  const permissions = JSON.parse(sessionStorage.getItem('token_permissions') || '{}');
  
  // 保存验证信息
  sessionStorage.setItem('admin_token', token);
  sessionStorage.setItem('admin_verified', 'true');
  sessionStorage.setItem('admin_login_time', Date.now().toString());
  sessionStorage.setItem('admin_permissions', JSON.stringify(permissions));
  sessionStorage.setItem('selected_module', module);
  
  // 导航到选择的模块
  navigateToModule(module);
}

// 导航到模块页面
function navigateToModule(module) {
  // 根据模块名称跳转到对应页面
  let pageUrl = '';
  switch(module) {
    case 'blog':
      pageUrl = 'blog.html';
      break;
    case 'portfolio':
      pageUrl = 'portfolio.html';
      break;
    case 'contact':
      pageUrl = 'contact.html';
      break;
    case 'config':
      pageUrl = 'config.html';
      break;
    default:
      pageUrl = 'index.html';
  }
  window.location.href = pageUrl;
}

// 显示普通弹窗
function showModal(title, message, type = 'info', showCancel = false) {
  const modal = document.getElementById('customModal');
  const modalTitle = document.querySelector('.modal-title');
  const modalMessage = document.getElementById('modalMessage');
  const headerIcon = document.querySelector('.modal-header i');
  const confirmBtn = document.getElementById('modalConfirmBtn');
  const cancelBtn = document.getElementById('modalCancelBtn');
  
  // 设置类型样式
  modal.className = `custom-modal modal-${type} show`;
  
  // 设置图标
  if (type === 'success') {
    headerIcon.className = 'fas fa-check-circle';
  } else if (type === 'error') {
    headerIcon.className = 'fas fa-exclamation-circle';
  } else {
    headerIcon.className = 'fas fa-info-circle';
  }
  
  // 设置内容
  modalTitle.textContent = title;
  modalMessage.innerHTML = message.replace(/\n/g, '<br>');
  
  // 设置按钮
  cancelBtn.style.display = showCancel ? 'inline-block' : 'none';
  confirmBtn.textContent = showCancel ? '确定' : '好的';
}

// 显示加载弹窗
function showLoadingModal(message) {
  const modal = document.getElementById('customModal');
  const modalTitle = document.querySelector('.modal-title');
  const modalMessage = document.getElementById('modalMessage');
  const headerIcon = document.querySelector('.modal-header i');
  const confirmBtn = document.getElementById('modalConfirmBtn');
  const cancelBtn = document.getElementById('modalCancelBtn');
  
  modal.className = 'custom-modal modal-info show';
  headerIcon.className = 'fas fa-spinner fa-spin';
  modalTitle.textContent = '请稍候';
  modalMessage.textContent = message;
  confirmBtn.style.display = 'none';
  cancelBtn.style.display = 'none';
}

// 关闭普通弹窗
function closeModal() {
  document.getElementById('customModal').classList.remove('show');
}

// 安全增强：页面卸载时清除临时存储
window.addEventListener('beforeunload', () => {
  sessionStorage.removeItem('pending_admin_token');
  sessionStorage.removeItem('pending_selected_module');
  sessionStorage.removeItem('token_permissions');
});
</script>
</body>
</html>
