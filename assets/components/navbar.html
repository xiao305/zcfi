<header>
    <div class="container">
        <nav class="navbar">
            <a href="#" class="logo" id="siteLogo"></a>
            <ul class="nav-links" id="mainNavLinks"></ul>
            <div class="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </div>
        </nav>
    </div>
</header>

<script>
// 导航栏配置加载器
class NavbarLoader {
    constructor() {
        this.CONFIG_GIST_ID = '983bb7371ddb439a2fcbfb4885e34d14';
        this.configData = null;
    }

    async loadConfig() {
        if (this.configData) return this.configData;
        
        try {
            const timestamp = Date.now();
            const response = await fetch(
                `https://gist.githubusercontent.com/xiao305/${this.CONFIG_GIST_ID}/raw/config.json?t=${timestamp}`
            );
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            this.configData = await response.json();
            return this.configData;
        } catch (error) {
            console.error('导航栏配置加载失败:', error);
            return this.getEmptyConfig();
        }
    }

    getEmptyConfig() {
        return {
            site: { name: '' },
            navigation: { items: [] }
        };
    }

    escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    normalizeUrl(url) {
        if (!url) return '#';
        if (url.startsWith('http://') || url.startsWith('https://') || url.startsWith('/')) {
            return url;
        }
        return url;
    }

    isCurrentPage(url) {
        if (!url) return false;
        
        const currentPath = window.location.pathname;
        const currentPage = currentPath.split('/').pop() || 'index.html';
        
        // 移除可能的查询参数和哈希
        const cleanUrl = url.split('?')[0].split('#')[0];
        const cleanCurrent = currentPage.split('?')[0].split('#')[0];
        
        // 如果是首页
        if (cleanUrl === './' || cleanUrl === 'index.html' || cleanUrl.endsWith('/')) {
            return cleanCurrent === 'index.html' || cleanCurrent === '';
        }
        
        // 检查是否匹配
        return cleanCurrent === cleanUrl || cleanCurrent.includes(cleanUrl.replace('.html', ''));
    }

    async render() {
        const config = await this.loadConfig();
        const site = config.site || {};
        const navigation = config.navigation || {};
        
        // 1. 更新Logo
        const siteLogo = document.getElementById('siteLogo');
        if (siteLogo) {
            siteLogo.innerHTML = site.name ? 
                `${this.escapeHtml(site.name)}<span>.</span>cn` : 
                'zcfi<span>.</span>cn';
            siteLogo.href = this.normalizeUrl('./');
        }
        
        // 2. 更新导航菜单
        const navLinksContainer = document.getElementById('mainNavLinks');
        if (navLinksContainer) {
            if (navigation.items && Array.isArray(navigation.items)) {
                // 按order排序
                const sortedItems = [...navigation.items].sort((a, b) => (a.order || 0) - (b.order || 0));
                
                const navHtml = sortedItems
                    .filter(item => item && item.name && item.url)
                    .map(item => {
                        const isActive = this.isCurrentPage(item.url);
                        const activeClass = isActive ? 'active' : '';
                        return `
                            <li>
                                <a href="${this.normalizeUrl(item.url)}" class="nav-link ${activeClass}">
                                    ${this.escapeHtml(item.name)}
                                </a>
                            </li>
                        `;
                    }).join('');
                
                navLinksContainer.innerHTML = navHtml;
            } else {
                navLinksContainer.innerHTML = '';
            }
        }
        
        // 3. 初始化移动端菜单
        this.initMobileMenu();
    }

    initMobileMenu() {
        const mobileBtn = document.querySelector('.mobile-menu-btn');
        const navLinks = document.querySelector('.nav-links');
        
        if (!mobileBtn || !navLinks) return;
        
        mobileBtn.addEventListener('click', () => {
            navLinks.classList.toggle('active');
            const icon = mobileBtn.querySelector('i');
            icon.classList.toggle('fa-bars');
            icon.classList.toggle('fa-times');
        });

        // 点击菜单项关闭菜单
        navLinks.addEventListener('click', (e) => {
            if (e.target.tagName === 'A') {
                navLinks.classList.remove('active');
                const icon = mobileBtn.querySelector('i');
                icon.classList.add('fa-bars');
                icon.classList.remove('fa-times');
            }
        });
    }
}

// 初始化
document.addEventListener('DOMContentLoaded', () => {
    const navbarLoader = new NavbarLoader();
    navbarLoader.render();
});
</script>
